AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Root CloudFormation template for an e-commerce website infrastructure.
  This template orchestrates the deployment of all nested stacks:
  network, endpoints, compute, database, and edge.


Parameters:

  ProjectName:
    Type: String
    Description: Project name prefix for resource naming
    Default: candy-store

  ContainerName:
    Type: String
    Description: Container name
    Default: candy-store-api

  ContainerVersion:
    Type: String
    Description: Container image tag to deploy (e.g. latest, v1.0.0)
    Default: latest  # Delete Default

  EcrRepositoryUri:
    Type: String
    Description: URI of ECR Repository
  
  VpcCidr:
    Type: String
    Description: The CIDR block for the VPC
    Default: "10.0.0.0/16"
    AllowedPattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    ConstraintDescription: "Must be a valid CIDR block, e.g., 10.0.0.0/16"
  
  Environment:
    Type: String
    Description: Deployment environment
    Default: dev
    AllowedValues:
      - dev
      - prod
  
  NestedTemplateURL:
    Type: String
    Description: >
      URL of root directory where the nested stack templates are stored (network.yaml, endpoints.yaml, compute.yaml, database.yaml, edge.yaml)
      Can be Github (https://raw.githubusercontent.com/YOUR_GITHUB_USERNAME/YOUR_REPO_NAME/main/cloudformation/) or S3 (https://BUCKET_NAME.s3.amazonaws.com/)
    Default: https://raw.githubusercontent.com/floydmoratti/aws-ecommerce-infrastructure/dev/cloudformation/

  DesiredCount:
    Type: Number
    Description: Desired count for main ECS service.
    Default: 0

  BackupDesiredCount:
    Type: Number
    Description: Desired count for pilot light ECS service. Can be updated by Step Functions or manually.
    Default: 0


Resources:

  # ----------------------
  # Nested Stacks
  # ----------------------

  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${NestedTemplateURL}network.yaml"
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        VpcCidr: !Ref VpcCidr
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    # Nested stack for network resources: VPC, subnets, routes, and Internet Gateway.
    # Resources are deleted on stack removal to avoid ongoing demo costs
  

  EndpointsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${NestedTemplateURL}endpoints.yaml"
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PublicAlbSubnet1a: !GetAtt NetworkStack.Outputs.PublicAlbSubnet1a
        PrivateEcsSubnet2a: !GetAtt NetworkStack.Outputs.PrivateEcsSubnet2a
        PrivateDbSubnet3a: !GetAtt NetworkStack.Outputs.PrivateDbSubnet3a
        PublicEcsSubnet2b: !GetAtt NetworkStack.Outputs.PublicEcsSubnet2b
        PrivateDbSubnet3b: !GetAtt NetworkStack.Outputs.PrivateDbSubnet3b
        InternetGatewayId: !GetAtt NetworkStack.Outputs.InternetGatewayId
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    # Nested stack for endpoints: NAT Gateway, S3 Gateway and Private Routes.
    # Depends on the NetworkStack because it needs VPC and subnet information


  DatabaseStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${NestedTemplateURL}database.yaml"
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PrivateDbSubnet3a: !GetAtt NetworkStack.Outputs.PrivateDbSubnet3a
        PrivateDbSubnet3b: !GetAtt NetworkStack.Outputs.PrivateDbSubnet3b
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    # Nested stack for the Aurora Serverless database
    # Depends on the NetworkStack because it requires private subnets


  ComputeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${NestedTemplateURL}compute.yaml"
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PublicAlbSubnet1a: !GetAtt NetworkStack.Outputs.PublicAlbSubnet1a
        PrivateEcsSubnet2a: !GetAtt NetworkStack.Outputs.PrivateEcsSubnet2a
        PublicAlbSubnet1b: !GetAtt NetworkStack.Outputs.PublicAlbSubnet1b
        PublicEcsSubnet2b: !GetAtt NetworkStack.Outputs.PublicEcsSubnet2b
        DatabaseSecretArn: !GetAtt DatabaseStack.Outputs.DatabaseSecretArn
        DbSecurityGroup: !GetAtt DatabaseStack.Outputs.DbSecurityGroup
        DesiredCount: !Ref DesiredCount
        BackupDesiredCount: !Ref BackupDesiredCount
        ContainerName: !Ref ContainerName
        ContainerVersion: !Ref ContainerVersion
        EcrRepositoryUri: !Ref EcrRepositoryUri
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    # Nested stack for ECS compute resources, ALB, IAM roles, and Secrets Manager
    # Depends on NetworkStack, DatabaseStack, and EndpointsStack


  EdgeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${NestedTemplateURL}edge.yaml"
      Parameters:
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        AlbDnsName: !GetAtt ComputeStack.Outputs.AlbDnsName
        S3BucketName: !GetAtt ComputeStack.Outputs.StaticContentBucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    # Nested stack for CloudFront and S3 static content distribution
    # Depends on ComputeStack because it uses the ALB and S3 bucket outputs


Outputs:

  NetworkStackId:
    Description: Stack ID of the network resources
    Value: !Ref NetworkStack
  
  ComputeStackId:
    Description: Stack ID of the compute resources
    Value: !Ref ComputeStack

  DatabaseStackId:
    Description: Stack ID of the database resources
    Value: !Ref DatabaseStack

  EdgeStackId:
    Description: Stack ID of the edge resources
    Value: !Ref EdgeStack