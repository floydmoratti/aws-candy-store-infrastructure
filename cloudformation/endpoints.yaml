AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Endpoints stack for aws-ecommerce-infrastructure.
  Creates a single NAT Gateway for ECS in AZ1,
  isolated route tables for Aurora,
  and an S3 Gateway Endpoint for private ECS access.


Parameters:

  ProjectName:
    Type: String
    Description: Project name prefix for resource naming
    Default: candy-store  # Delete Default
  
  Environment:
    Type: String
    Description: Deployment environment
    Default: dev  # Delete Default
  
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID from network stack

  PublicAlbSubnet1a:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnet for ALB and NAT Gateway in AvailabilityZone-A (main)

  PrivateEcsSubnet2a:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet for ECS in AvailabilityZone-A (main)

  PrivateDbSubnet3a:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet for Aurora in AvailabilityZone-A (main)

  PublicEcsSubnet2b:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnet for ECS in AvailabilityZone-B (backup)
  
  PrivateDbSubnet3b:
    Type: AWS::EC2::Subnet::Id
    Description: Private subnet for Aurora in AvailabilityZone-B (backup)
  
  InternetGatewayId:
    Type: String
    Description: Internet Gateway Id (igw-xxxxxxxx)


Resources:

  # ----------------------
  # NAT Gateway (AZ-A)
  # ----------------------

  NatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-nat-eip"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
    # Elastic IP for NAT Gateway
  
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEip.AllocationId
      SubnetId: !Ref PublicAlbSubnet1a
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-nat-gateway"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
    # NAT Gateway for ECS in AvailabilityZone-A (main)

  
  # ----------------------
  # Route Tables
  # ----------------------

  # ECS (AZ-a)
  PrivateEcsSubnet2aRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-ecs-private2a-rt"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  PrivateEcsSubnet2aNatRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateEcsSubnet2aRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateEcsSubnet2aAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateEcsSubnet2a
      RouteTableId: !Ref PrivateEcsSubnet2aRouteTable

  
  # ECS (AZ-b)
  PublicEcsSubnet2bRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-ecs-public2b-rt"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
  
  PublicEcsSubnet2bInternetRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicEcsSubnet2bRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGatewayId
  
  PublicEcsSubnet2bAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicEcsSubnet2b
      RouteTableId: !Ref PublicEcsSubnet2bRouteTable


  # Database (AZ-a)
  PrivateDbSubnet3aRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-db-private3a-rt"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
    # No default route — database is fully isolated

  PrivateDbSubnet3aAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDbSubnet3a
      RouteTableId: !Ref PrivateDbSubnet3aRouteTable


  # Database (AZ-b)
  PrivateDbSubnet3bRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcId
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-db-private3b-rt"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
    # No default route — database is fully isolated

  PrivateDbSubnet3bAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDbSubnet3b
      RouteTableId: !Ref PrivateDbSubnet3bRouteTable

  
  # ----------------------
  # Gateway Endpoint
  # ----------------------

  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VpcId
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateEcsSubnet2aRouteTable
        - !Ref PublicEcsSubnet2bRouteTable
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-s3-endpoint"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
    # Allows ECS tasks to access S3 without traversing the NAT Gateway
    # Reduces cost and keeps traffic within AWS backbone
    # Attached to public ECS route table so pilot-light tasks
    # can access S3 without NAT during AZ-A failover


Outputs:
  NatGatewayId:
    Description: NAT Gateway ID (AZ-a only)
    Value: !Ref NatGateway
  
  NatEip:
    Description: NAT Gateway Elastic IP (AZ-a only)
    Value: !Ref NatEip