AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Data stack for aws-ecommerce-infrastructure.
  Creates DynamoDB tables for Products, Carts, and Orders with
  GSIs, encryption, backups, and TTL configuration.



Parameters:

  ProjectName:
    Type: String

  Environment:
    Type: String

  EnablePointInTimeRecovery:
    Type: String



Conditions:

  IsDev: !Equals [!Ref Environment, dev]
  IsProd: !Equals [!Ref Environment, prod]
  UseProvisionedThroughput: !Condition IsDev
  EnablePITR: !Or
    - !Equals [!Ref EnablePointInTimeRecovery, "true"]
    - !Condition IsProd



Resources:

  # ----------------------
  # DynamoDB Tables
  # ----------------------
  
  ProductsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: !If [IsProd, Retain, Delete]
    UpdateReplacePolicy: !If [IsProd, Retain, Delete]
    Properties:
      TableName: !Sub "${ProjectName}-${Environment}-products"
      BillingMode: !If [UseProvisionedThroughput, PROVISIONED, PAY_PER_REQUEST]
      ProvisionedThroughput: !If
        - UseProvisionedThroughput
        - ReadCapacityUnits: 9
          WriteCapacityUnits: 5
        - !Ref AWS::NoValue
      AttributeDefinitions:
        - AttributeName: productId
          AttributeType: S
      KeySchema:
        - AttributeName: productId
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [EnablePITR, true, false]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-products"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  CartsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: !If [IsProd, Retain, Delete]
    UpdateReplacePolicy: !If [IsProd, Retain, Delete]
    Properties:
      TableName: !Sub "${ProjectName}-${Environment}-carts"
      BillingMode: !If [UseProvisionedThroughput, PROVISIONED, PAY_PER_REQUEST]
      ProvisionedThroughput: !If
        - UseProvisionedThroughput
        - ReadCapacityUnits: 5
          WriteCapacityUnits: 9
        - !Ref AWS::NoValue
      AttributeDefinitions:
        - AttributeName: cartId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: cartId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserCartsIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - UseProvisionedThroughput
            - ReadCapacityUnits: 2
              WriteCapacityUnits: 2
            - !Ref AWS::NoValue
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [EnablePITR, true, false]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-carts"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  OrdersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: !If [IsProd, Retain, Delete]
    UpdateReplacePolicy: !If [IsProd, Retain, Delete]
    Properties:
      TableName: !Sub "${ProjectName}-${Environment}-orders"
      BillingMode: !If [UseProvisionedThroughput, PROVISIONED, PAY_PER_REQUEST]
      ProvisionedThroughput: !If
        - UseProvisionedThroughput
        - ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        - !Ref AWS::NoValue
      AttributeDefinitions:
        - AttributeName: orderId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: N
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: orderId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserOrdersIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - UseProvisionedThroughput
            - ReadCapacityUnits: 2
              WriteCapacityUnits: 2
            - !Ref AWS::NoValue
        - IndexName: StatusOrdersIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - UseProvisionedThroughput
            - ReadCapacityUnits: 2
              WriteCapacityUnits: 2
            - !Ref AWS::NoValue
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [EnablePITR, true, false]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-orders"
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment



Outputs:

  ProductsTableName:
    Description: Products DynamoDB table name
    Value: !Ref ProductsTable
    Export:
      Name: !Sub "${ProjectName}-${Environment}-ProductsTableName"

  ProductsTableArn:
    Description: Products DynamoDB table ARN
    Value: !GetAtt ProductsTable.Arn
    Export:
      Name: !Sub "${ProjectName}-${Environment}-ProductsTableArn"

  CartsTableName:
    Description: Carts DynamoDB table name
    Value: !Ref CartsTable
    Export:
      Name: !Sub "${ProjectName}-${Environment}-CartsTableName"

  CartsTableArn:
    Description: Carts DynamoDB table ARN
    Value: !GetAtt CartsTable.Arn
    Export:
      Name: !Sub "${ProjectName}-${Environment}-CartsTableArn"

  OrdersTableName:
    Description: Orders DynamoDB table name
    Value: !Ref OrdersTable
    Export:
      Name: !Sub "${ProjectName}-${Environment}-OrdersTableName"

  OrdersTableArn:
    Description: Orders DynamoDB table ARN
    Value: !GetAtt OrdersTable.Arn
    Export:
      Name: !Sub "${ProjectName}-${Environment}-OrdersTableArn"
